var C=Object.defineProperty;var E=(n,e,r)=>e in n?C(n,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[e]=r;var u=(n,e,r)=>E(n,typeof e!="symbol"?e+"":e,r);import{t as w,a4 as I,o as T,b7 as F,ah as U}from"./index-DV7Tvt5Y.js";class D{constructor(){u(this,"requestInterceptors",[]);u(this,"responseInterceptors",[])}async useRequest(e){this.requestInterceptors.push(e)}async useResponse(e){this.responseInterceptors.push(e)}getRequestInterceptors(){return this.requestInterceptors}getResponseInterceptors(){return this.responseInterceptors}}class g{constructor(){u(this,"options",{});u(this,"interceptors",new D);u(this,"abortControllers",new Map);u(this,"cache",new Map)}setBaseUrl(e){return this.options.baseUrl=e,this}setHeaders(e){return this.options.headers=e,this}interceptor(){return this.interceptors}cancelRequest(e){const r=this.abortControllers.get(e);return r?(r.abort(),this.abortControllers.delete(e),!0):!1}clearCache(){this.cache.clear()}async request(e){return new Promise(async(r,p)=>{var y;const d=[this.options.baseUrl||"",e.url].join("");if(e.cache&&((y=e.method)==null?void 0:y.toUpperCase())==="GET"){const o=d+JSON.stringify(e.body||{}),a=this.cache.get(o);if(a){const h=Date.now(),s=e.cacheTTL||6e4;if(h-a.timestamp<s)return r(a.data);this.cache.delete(o)}}let t={...e,url:d};this.interceptors.getRequestInterceptors().forEach(o=>{t=o(t)});const f=new AbortController;this.abortControllers.set(t.url,f);let c;t.timeout&&(c=window.setTimeout(()=>{f.abort(),this.abortControllers.delete(t.url),p(new Error(`Request timeout after ${t.timeout}ms`))},t.timeout));try{let o=0;const a=t.retry||0,h=t.retryDelay||1e3,s=async()=>{var q;try{const i=await fetch(t.url,{method:t.method||"GET",headers:{...this.options.headers||{},...t.headers||{}},body:t.body instanceof FormData?t.body:t.body?JSON.stringify(t.body):void 0,signal:f.signal});if(!i.ok)throw new Error(`HTTP error! Status: ${i.status}`);let m=await i.json();if(this.interceptors.getResponseInterceptors().forEach(b=>{m=b(m)}),t.cache&&((q=t.method)==null?void 0:q.toUpperCase())==="GET"){const b=t.url+JSON.stringify(t.body||{});this.cache.set(b,{data:m,timestamp:Date.now()})}return m}catch(i){if(o<a&&!(i instanceof DOMException&&i.name==="AbortError"))return o++,await new Promise(v=>setTimeout(v,h)),s();throw i}},l=await s();r(l)}catch(o){p(o)}finally{c!==void 0&&clearTimeout(c),this.abortControllers.delete(t.url)}})}static create(){return new g}}const R=g.create().setBaseUrl("/api").setHeaders({"Content-Type":"application/json"});R.interceptor().useRequest(n=>n);R.interceptor().useResponse(n=>n);const x=(n,e)=>{const r=w(null),p=w([]),d=w([]),t=a=>{p.value.push(a)},f=a=>{d.value.push(a)},c=I({data:n,isFetching:!1,error:null}),y=async()=>{var h;c.isFetching=!0,c.error=null;let a=e.url;if(e.params){const s=e.params(),l=new URLSearchParams(s).toString();a=`${e.url}?${l}`}if(e.pathVariables){const s=e.pathVariables();Object.keys(s).forEach(l=>{a=e.url.replace(`:${l}`,s[l])})}try{r.value&&r.value.abort(),r.value=new AbortController;const s=await R.request({...e,url:a,body:(h=e.body)==null?void 0:h.call(e),signal:r.value.signal});return s.data&&(c.data=s.data),p.value.forEach(l=>l(s)),s.data}catch(s){c.error=s,d.value.forEach(l=>l(s))}finally{c.isFetching=!1,r.value=null}},o=()=>{r.value&&(r.value.abort(),r.value=null,c.isFetching=!1)};return T(()=>{e.immediate!==!1&&y()}),F(()=>{o()}),{...U(c),execute:y,cancel:o,onFetchError:f,onFetchResponse:t}};export{x as u};
